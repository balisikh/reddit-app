<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Clone</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <h1>Reddit Clone</h1>
            <div class="auth-links">
                <a href="#">Log In</a>
                <a href="#">Sign Up</a>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="search-section">
            <input type="text" placeholder="Search posts..." class="search-input">
            <button class="search-button">Search</button>
        </div>

        <div class="posts-container">
            <div class="post-card">
                <h2>Learning React</h2>
                <p>React is a library for building user interfaces.</p>
                <p class="author">Author: John Doe</p>
            </div>
            
            <div class="post-card">
                <h2>Understanding Redux</h2>
                <p>Redux is a state management tool</p>
                <p class="author">Author: John Doe</p>
            </div>
            
            <div class="post-card">
                <h2>Styling with CSS</h2>
                <p>CSS is used to style web pages</p>
                <p class="author">Author: John Doe</p>
            </div>
        </div>
    </main>
    <script>
    const postsContainer = document.querySelector('.posts-container');
    const searchInput = document.querySelector('.search-input');
    const searchButton = document.querySelector('.search-button');

    let lastRequestTime = 0;
    const RATE_LIMIT_MS = 2000; // 2 seconds between requests
    let after = null;           // Pagination pointer
    let currentSubreddit = "javascript";
    let isLoading = false;

    function renderError(message) {
      postsContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function renderLoading() {
      postsContainer.innerHTML += `<div class="loading-message">Loading Reddit posts...</div>`;
    }

    function renderPostCard(post) {
      const { author, title, selftext, permalink, ups, num_comments, thumbnail } = post.data;
      const validThumbnail = thumbnail && thumbnail.startsWith("http");

      return `
        <div class="post-card">
          <div class="post-votes">‚¨ÜÔ∏è ${ups}</div>
          <div class="post-content">
            <h2>
              <a href="https://reddit.com${permalink}" target="_blank">${title}</a>
            </h2>
            ${validThumbnail ? `<img src="${thumbnail}" alt="thumbnail" class="post-thumbnail">` : ""}
            <p>${selftext ? selftext.substring(0, 150) + "..." : ""}</p>
            <div class="post-meta">
              <span>üë§ ${author || "Anonymous"}</span>
              <span>üí¨ ${num_comments} comments</span>
            </div>
          </div>
        </div>
      `;
    }

    async function fetchRedditPosts(subreddit, loadMore = false) {
      const now = Date.now();
      if (now - lastRequestTime < RATE_LIMIT_MS) {
        return;
      }
      lastRequestTime = now;

      if (!loadMore) {
        postsContainer.innerHTML = "";
        after = null;
      }

      if (isLoading) return;
      isLoading = true;

      if (loadMore) renderLoading();

      try {
        let url = `https://www.reddit.com/r/${subreddit}/hot.json?limit=10`;
        if (after) url += `&after=${after}`;

        const response = await fetch(url);

        if (!response.ok) {
          if (response.status === 429) {
            throw new Error('API Rate Limit Exceeded. Please try again later.');
          }
          throw new Error(`Error fetching posts: ${response.statusText}`);
        }

        const data = await response.json();
        after = data.data.after;

        if (data.data.children.length === 0) {
          if (!loadMore) renderError(`No posts found for r/${subreddit}.`);
          return;
        }

        const postsHtml = data.data.children.map(renderPostCard).join('');
        if (loadMore) {
          const loadingEl = document.querySelector(".loading-message");
          if (loadingEl) loadingEl.remove();
          postsContainer.innerHTML += postsHtml;
        } else {
          postsContainer.innerHTML = postsHtml;
        }

      } catch (error) {
        console.error("Fetch error:", error);
        renderError(`Failed to load posts: ${error.message}`);
      } finally {
        isLoading = false;
      }
    }

    // Initial fetch
    fetchRedditPosts(currentSubreddit);

    // Search button
    searchButton.addEventListener('click', () => {
      currentSubreddit = searchInput.value.trim() || 'javascript';
      fetchRedditPosts(currentSubreddit);
    });

    // Enter key
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        currentSubreddit = searchInput.value.trim() || 'javascript';
        fetchRedditPosts(currentSubreddit);
      }
    });

    // Infinite scroll
    window.addEventListener("scroll", () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
        if (after) {
          fetchRedditPosts(currentSubreddit, true);
        }
      }
    });
  </script>
</body>
</html>